# claude-example

Claude Codeに関するベストプラクティスや設定（CLAUDE.md、Rules、Skills、Subagents など）を整理し、実際に試してみるためのプロジェクトです。

---

## Claude Code カスタマイズガイド

Claude Codeのカスタマイズを **5つのレイヤー** で整理したガイド。

> 参考: [Claude Code Customization Guide](https://marioottmann.com/articles/claude-code-customization-guide)

---

### 全体構造：5つのカスタマイズレイヤー

内側（設定系）から外側（外部連携）へ、以下の順で構成される。

| レイヤー | 役割 | いつ使うか |
|---|---|---|
| **CLAUDE.md** | 常に読み込まれるマスター設定 | フレームワーク規約、標準の索引 |
| **Rules** | ドメイン固有の知識（パスでフィルタ可能） | デザインシステム、セキュリティパターン、DB仕様 |
| **Skills** | ユーザーが手動で起動するワークフロー | アーキテクチャ判断、定型ページ生成 |
| **Subagents** | 複雑なタスクを自律的に処理する専門エージェント | セキュリティ監査、コードベース探索 |
| **MCPs** | 外部ツール・サービスとの連携 | GitHub、DB、Slack等 |

---

### 各レイヤーの詳細

#### 1. CLAUDE.md — 基盤設定

- プロジェクト全体の「憲法」のような存在
- **常にコンテキストに読み込まれる**ため、簡潔に保つことが重要
- フレームワーク規約や標準への参照を記述する場所

#### 2. Rules — ドメイン知識

- `.claude/rules/` ディレクトリに配置
- **パスベースのフィルタリング**が可能（例：`src/components/` 配下のファイル編集時だけ適用）
- CLAUDE.mdに書くと肥大化する詳細なドメイン知識を分離して管理できる

#### 3. Skills — 再利用可能なワークフロー

- `/スキル名` のスラッシュコマンドで呼び出す
- 複数ファイルで構成可能（`SKILL.md` + `examples.md` + `reference.md`）
- **ユーザーの入力・判断が必要な繰り返しタスク**に適している

#### 4. Subagents — 自律的な専門エージェント

- 複雑なマルチステップタスクを**自律的に**処理する
- セキュリティレビュー、コードベース探索などに活用

#### 5. MCPs（Model Context Protocol）— 外部連携

- GitHub、データベース、Slackなど外部サービスとの接続
- 内部設定を整えた**後に**導入するのが推奨

---

### ファイル配置

```
プロジェクトレベル:  .claude/         （リポジトリ内）
グローバルレベル:    ~/.claude/        （全プロジェクト共通）
```

---

### 選定フローチャート

迷ったときの判断基準：

1. プロジェクト全体の標準？ → **CLAUDE.md**
2. 深いドメイン知識？ → **Rules**
3. ユーザー入力を伴う繰り返しワークフロー？ → **Skills**
4. 複雑な自律タスク？ → **Subagents**
5. 外部ツールへのアクセス？ → **MCPs**

---

### よくある失敗パターン

| アンチパターン | 問題点 |
|---|---|
| CLAUDE.mdを作らない | 基盤なしに他のレイヤーを使うことになる |
| CLAUDE.mdに詰め込みすぎ | 常に読み込まれるため、コンテキストを圧迫する |
| Rulesを「指示」として扱う | Rulesはドメイン知識であり、手順書ではない |
| パスフィルタリングを使わない | 不要なRulesが無関係なファイル編集時にも適用される |
| Skillsを自律タスクに使う | Skillsはユーザー起動型。自律処理はSubagentsが適切 |
| MCPを避ける | 外部連携が必要な場面でMCPを使わないと非効率 |

---

### 推奨される導入順序

```
CLAUDE.md → Rules → Skills → Subagents → MCPs
```

内部設定を先に固めてから、外部連携（MCPs）を追加するのが効果的。

---

## Claude Code ベストプラクティスまとめ

6つの情報源を横断調査し、Claude Codeを効果的に使うための知見を体系的に整理したガイド。

### 全体像：3つの層

| 層 | カテゴリ | 概要 |
|---|---|---|
| **基盤** | コンテキスト管理 / CLAUDE.md設計 | これなしでは始まらない土台 |
| **実践** | ワークフロー / プロンプティング / 検証 | 日々の作業フロー |
| **拡張** | 環境設定 / スキル / 並列実行 / セッション管理 | さらに使いこなすための応用 |

---

### 1. コンテキスト管理（最重要）

全ソースが一致して指摘する最重要事項。コンテキストウィンドウ（約200kトークン）は有限で、埋まるほど性能が劣化する。

#### 実践テクニック

| テクニック | 説明 |
|---|---|
| `/clear`の頻繁な使用 | 無関係なタスク間でコンテキストをリセット |
| 新しい会話の開始 | トピックが変わったら新しい会話を始める |
| `/compact`の活用 | 手動でコンテキストを圧縮（`/compact APIの変更に注目` のように焦点指定も可） |
| サブエージェントの活用 | 調査を別コンテキストで実行し、要約だけ返す |
| HANDOFF.mdの作成 | 進捗をまとめたファイルを作成し、新しい会話に引き継ぐ |

#### アンチパターン

- **キッチンシンク・セッション** — 1つの会話で無関係なタスクを混在させる → `/clear`で解決
- **無限探索** — スコープ未限定の調査で大量ファイルを読み込む → サブエージェント使用またはスコープを狭める
- **訂正の繰り返し** — 2回訂正しても直らなければ、`/clear`して改善プロンプトで再開

---

### 2. CLAUDE.mdの設計と運用

「削除したらClaudeがミスするか？」を基準に簡潔に保つことが鉄則。

#### 含めるべき内容と避けるべき内容

| 含めるべき | 避けるべき |
|---|---|
| ビルド・テスト・リントのコマンド | コードを読めばわかること |
| コーディング規約 | 言語の標準的慣例（Claudeは既に知っている） |
| ディレクトリ構成とアーキテクチャ | 頻繁に変わる情報 |
| ドメイン固有の用語 | 詳細なAPIドキュメント（リンクで代替） |
| ワークフロー手順 | 自明な実践（「クリーンなコードを書く」等） |

#### 配置場所

| パス | 適用範囲 |
|---|---|
| `~/.claude/CLAUDE.md` | 全プロジェクト共通 |
| `./CLAUDE.md`（プロジェクトルート） | チーム共有（gitにコミット） |
| `./CLAUDE.local.md` | 個人設定（`.gitignore`に追加） |
| 子ディレクトリ内 | そのディレクトリ作業時にオンデマンドで読み込み |

#### 運用ポイント

- 重要な指示には「IMPORTANT」や「YOU MUST」を付けて強調する
- `@docs/git-instructions.md` のように外部ファイルをインポート参照できる
- 定期的にレビューし、不要な項目を削除する

---

### 3. ワークフロー：探索→計画→実装→コミット

#### 4段階フロー

1. **探索（Plan Mode）** — ファイルを読み込み、構造を理解する（変更は行わない）
2. **計画（Plan Mode）** — 詳細な実装計画を作成させる
3. **実装（Normal Mode）** — 計画に基づいてコーディング。テスト実行と修正を含める
4. **コミット** — 説明的なメッセージでコミットし、PRを作成

スコープが明確で修正が小さい場合（タイポ修正、変数名変更等）は計画フェーズをスキップしてよい。

---

### 4. 効果的なプロンプティング

#### 指示の出し方

| 戦略 | 悪い例 | 良い例 |
|---|---|---|
| タスクの範囲を限定 | 「foo.pyにテストを追加して」 | 「foo.pyにログアウト時のエッジケーステストを書いて。モックは避けて」 |
| 情報源を指定 | 「APIが変な理由は？」 | 「git履歴を調べてAPIの経緯を要約して」 |
| 既存パターンを参照 | 「ウィジェットを追加して」 | 「HotDogWidget.phpのパターンに従って実装して」 |
| 症状を詳述 | 「ログインバグを直して」 | 「セッションタイムアウト後にログインが失敗する。再現テストを書いてから修正して」 |

#### リッチコンテンツの活用

- `@` でファイルを参照
- 画像を直接ペースト
- URLでドキュメントを提供
- `cat error.log | claude` でデータをパイプ

#### インタビュー手法（大規模機能向け）

大きな機能の場合、最初にClaudeに質問させて仕様書を作成し、新しいセッションで実装に入る。

---

### 5. 検証 — 最もレバレッジが高い施策

Claudeが自分で正しさを確認できる手段を与えることが品質に直結する。

| 方法 | 説明 |
|---|---|
| テストの実行 | 実装後にテストを書かせて実行させる |
| スクリーンショット比較 | UI変更時に視覚的に検証 |
| リンター/ビルドチェック | `npm run lint` 等を実行させる |
| TDDの採用 | テストを先に書かせてから実装 |
| draft PRの活用 | ドラフトPRを作成し、レビュー後に正式化 |
| サブエージェントでレビュー | 別エージェントにコードレビューさせる |

---

### 6. 環境設定とツール活用

#### 権限設定

| モード | 説明 |
|---|---|
| default | 都度許可を求める（安全だがテンポが悪い） |
| acceptEdits | ファイル変更は自動承認 |
| plan | 読み取り専用 |
| bypassPermissions | 全権限をバイパス（コンテナ内限定推奨） |

#### MCPサーバー

- `claude mcp add` で外部ツール（Notion、Figma、DB等）を接続
- Playwright MCPでブラウザ自動操作が可能

#### Hooks

- CLAUDE.mdの指示は「助言的」だが、Hooksは「決定的」（確実に実行される）
- 例: ファイル編集後にeslintを自動実行、特定フォルダへの書き込みをブロック

---

### 7. スキルの活用

- `.claude/skills/` に `SKILL.md` として配置するドメイン知識・ワークフロー定義
- CLAUDE.mdとの違い: CLAUDE.mdは毎セッション読み込まれるが、スキルはオンデマンド
- YAML frontmatterでClaudeがいつスキルを読み込むか判断する
- コア指示に集中し、詳細なドキュメントは `references/` にリンクで参照

---

### 8. 並列実行とスケーリング

#### 並列セッション

- Git Worktreesで並列ブランチ作業
  ```bash
  git worktree add ../project-feature-a -b feature-a
  cd ../project-feature-a && claude
  ```
- Writer/Reviewerパターン: セッションAで実装、セッションBでレビュー

#### ヘッドレスモード

- `claude -p "prompt"` でCI/CDパイプライン、pre-commitフック、スクリプトに統合
- `--output-format json` で構造化出力
- `--allowedTools` で権限をスコープ

---

### 9. セッション管理テクニック

| テクニック | コマンド/操作 | 説明 |
|---|---|---|
| 中断 | `Esc` | 処理を停止（コンテキスト維持） |
| 巻き戻し | `Esc+Esc` または `/rewind` | チェックポイントに復元 |
| 元に戻す | `"Undo that"` | 変更を元に戻す |
| コンテキストリセット | `/clear` | 無関係なタスク間で使用 |
| 会話の再開 | `claude --continue` | 直近の会話を再開 |
| 会話の選択 | `claude --resume` | 過去の会話リストから選択 |

---

### 10. よくある失敗パターンと対策

| パターン | 症状 | 対策 |
|---|---|---|
| キッチンシンク・セッション | 無関係なタスクを1会話に混在 | `/clear`でタスク間をリセット |
| 訂正の繰り返し | 同じ間違いを何度も訂正 | 2回失敗したら`/clear`して改善プロンプトで再開 |
| CLAUDE.md肥大化 | 重要なルールが埋もれる | 定期的に剪定。Hooksに移行できるものは移行 |
| 信頼後検証ギャップ | エッジケース未対応の実装 | 常に検証手段（テスト、スクリプト）を提供 |
| 無限探索 | スコープ未限定で大量ファイル読み込み | サブエージェント使用またはスコープを狭める |

---

### 最重要ポイント TOP 5

1. **コンテキスト管理を徹底する** — `/clear`を頻繁に使い、会話を新鮮に保つ
2. **検証手段を必ず提供する** — テスト、リンター等でClaudeが自己チェックできる仕組みを用意する
3. **CLAUDE.mdを簡潔に保つ** — 少ないが効果的な指示。肥大化は性能低下に直結する
4. **探索→計画→実装の順序を守る** — いきなりコーディングさせず、理解を深めてから実装に移る
5. **サブエージェントとスキルで拡張する** — 調査はサブエージェントに委譲し、ドメイン知識はスキルで管理する

---

### 参考URL一覧

| # | ソース | 種別 |
|---|---|---|
| 1 | [Anthropic公式ドキュメント - Best Practices](https://code.claude.com/docs/en/best-practices) | 公式 |
| 2 | [Dometrain - Creating the Perfect CLAUDE.md](https://dometrain.com/blog/creating-the-perfect-claudemd-for-claude-code/) | ブログ |
| 3 | [Reddit/ykdojo - Top 10 Claude Code Tips (40+ Tips)](https://github.com/ykdojo/claude-code-tips) | コミュニティ |
| 4 | [Anthropic - The Complete Guide to Building Skills for Claude](https://resources.anthropic.com/hubfs/The-Complete-Guide-to-Building-Skill-for-Claude.pdf?hsLang=en) | 公式PDF |
| 5 | [VLD-BC - CLI Agents Part 2: Claude Code Best Practices](https://vld-bc.com/blog/cli-agents-part2-claude-code-best-practices) | ブログ |
| 6 | [Builder.io - Claude MD Guide](https://www.builder.io/blog/claude-md-guide) | ブログ |
