# Rules設定の整備

> ステータス: 実装完了
> 作成日: 2026-01-31
> 最終更新: 2026-01-31

---

## Part 1: 仕様 (Specification)

### 1.1 概要

**目的**: Claude Codeの `.claude/rules/` を活用し、プロジェクトのルールをモジュール分割して管理可能にする。

**スコープ**:
- 既存 `CLAUDE.md` の再構成（プロジェクト概要・コマンド情報のみに絞る）
- `.claude/rules/` にコーディング規約・テスト規約・Git規約のルールファイルを作成
- backend/ 向けのパス指定付き条件付きルールを作成

**動機**: 現在の `CLAUDE.md` にはプロジェクト情報・ワークフロー・スキル一覧が混在している。ルールをモジュール分割することで、メンテナンス性と見通しを改善する。

### 1.2 詳細仕様

#### 機能要件

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-001 | CLAUDE.md再構成 | プロジェクト概要・構造・開発コマンド・ベストプラクティスのみ残し、ルール的な内容は `.claude/rules/` へ移動 | 高 |
| F-002 | コーディング規約ルール | `.claude/rules/code-style.md` にコードスタイル・命名規則を定義 | 高 |
| F-003 | テスト規約ルール | `.claude/rules/testing.md` にテストの書き方・命名・配置を定義 | 高 |
| F-004 | Git規約ルール | `.claude/rules/git.md` にコミットメッセージ規約を定義 | 高 |
| F-005 | バックエンド専用ルール | `.claude/rules/backend.md` にbackend/配下のみ適用されるルールをパス指定付きで定義 | 中 |

#### ファイル構成（変更後）

```
project-root/
├── CLAUDE.md                      # プロジェクト概要・構造・コマンド（簡潔に）
├── .claude/
│   ├── rules/
│   │   ├── code-style.md          # コーディング規約（全体共通）
│   │   ├── testing.md             # テスト規約（全体共通）
│   │   ├── git.md                 # Git規約（全体共通）
│   │   └── backend.md             # バックエンド専用ルール（paths指定付き）
│   ├── commands/                   # 既存（変更なし）
│   └── skills/                     # 既存（変更なし）
```

#### 各ファイルの内容仕様

##### CLAUDE.md（再構成後）

残す内容:
- プロジェクト概要
- プロジェクト構造
- 開発コマンド
- CLAUDE.md・Rules のベストプラクティス（新規追加）

追加する「CLAUDE.md・Rules のベストプラクティス」セクション:
- 具体的に書く: 「コードを適切にフォーマットする」ではなく「インデントはスペース2つを使用する」のように記述する
- 構造化して整理する: 各ルールは箇条書きにし、関連するルールは見出しでグループ化する
- 定期的に見直す: プロジェクトの進化に合わせてルールを更新し、常に最新の情報を反映する

削除する内容（rules/へ移動または不要化）:
- 「計画と実装のワークフロー」セクション → `.claude/rules/workflow.md` へ移動
- 「Git規約」セクション → `.claude/rules/git.md` へ移動
- 「利用可能なスキル」セクション → 削除（スキルは `.claude/skills/` に自動検出される）
- 「SDD ワークフロー」セクション → `.claude/rules/workflow.md` へ移動

##### .claude/rules/code-style.md

以下を定義:
- モジュールシステム: アプリコードは CommonJS（`require`/`module.exports`）
- インデント: スペース2つ
- 文字列: シングルクォート
- セミコロン: あり
- 命名規則: キャメルケース（変数・関数）、パスカルケース（クラス）、大文字スネークケース（定数）
- 関数スタイル: アロー関数を優先
- コメント: 日本語で記述

##### .claude/rules/testing.md

以下を定義:
- フレームワーク: Vitest + Supertest
- テストファイル: `*.spec.js` でソースファイルと同階層に配置
- モジュールシステム: ESM（`import`/`export`）
- テスト記述言語: 日本語（`describe`/`it` の説明文）
- 構造: `describe` でエンドポイントまたは関数単位にグループ化
- アサーション: Vitest の `expect` を使用

##### .claude/rules/git.md

以下を定義:
- コミットメッセージ: 日本語で簡潔に

##### .claude/rules/backend.md（パス指定付き）

YAML frontmatter で `paths: ["backend/**"]` を指定し、以下を定義:
- フレームワーク: Express 5
- テンプレートエンジン: EJS
- ルート定義: `src/routes/` に配置、`express.Router()` を使用
- ビュー: `src/views/` に `.ejs` ファイルとして配置
- 定数: `src/constants.js` に集約
- アプリ起動: `require.main === module` パターンで `module.exports = app` によりテスト可能に

##### .claude/rules/workflow.md

CLAUDE.md から移動するワークフロー情報:
- 計画と実装のワークフロー（y-plan / y-implement）
- SDD ワークフロー（x-specify / x-plan / x-implement）

### 1.3 受入基準

| ID | Given (前提条件) | When (操作) | Then (期待結果) |
|----|-----------------|-------------|----------------|
| AC-001 | プロジェクトルートにいる | Claude Codeを起動する | CLAUDE.md と `.claude/rules/` 内の全ルールファイルが読み込まれる |
| AC-002 | `.claude/rules/backend.md` が存在する | backend/ 以外のファイルを操作する | backend.md のルールは適用されない |
| AC-003 | `.claude/rules/backend.md` が存在する | backend/ 内のファイルを操作する | backend.md のルールが適用される |
| AC-004 | 全ルールファイルが配置済み | `/memory` コマンドを実行する | 全ルールファイルが一覧に表示される |

### 1.4 エッジケース

| ID | シナリオ | 期待される動作 |
|----|----------|---------------|
| EC-001 | frontend/ ディレクトリが将来作成された場合 | backend.md のルールは frontend/ には適用されない。必要に応じて frontend.md を追加できる |

### 1.5 制約事項

#### セキュリティ
- ルールファイルに機密情報を含めない

#### パフォーマンス
- ルールファイルは起動時に全て読み込まれるため、各ファイルを簡潔に保つ

#### 依存関係

新規パッケージの追加なし。

### 1.6 テスト戦略

#### ユニットテスト
- 対象外（設定ファイルの変更のみのため）

#### 統合テスト
- Claude Code 起動後に `/memory` コマンドで全ルールファイルの読み込みを確認

### 1.7 不確実性

**未解決数**: 0

なし。

### 1.8 プロジェクト憲法チェックリスト

| 条 | 原則 | 準拠 | 備考 |
|----|------|------|------|
| I | モジュール先行 | - [x] | ルールをトピック別にモジュール分割する |
| II | 契約先行 | - [x] | 各ルールファイルの内容を仕様で事前定義している |
| III | テスト先行 | - [x] | 受入基準 AC-001〜AC-004 で確認手順を定義済み（コードテスト対象外） |
| IV | 仕様完全性 | - [x] | 未解決の不確実性なし |
| V | 最小依存 | - [x] | 新規パッケージの追加なし |
| VI | 関心の分離 | - [x] | コーディング規約・テスト規約・Git規約・バックエンド固有をそれぞれ分離 |
| VII | 簡潔性ゲート | - [x] | 各ルールファイルは1トピックに集中し簡潔に保つ |
| VIII | 直接利用 | - [x] | Claude Codeの標準 `.claude/rules/` 機能を直接利用 |
| IX | 統合テスト優先 | - [x] | `/memory` コマンドによる統合確認を定義済み |

---

## Part 2: 実装計画 (Implementation Plan)

### 2.1 進捗サマリー

| フェーズ | ステータス | 進捗 |
|---------|-----------|------|
| フェーズ1: ルールファイル作成 | 完了 | 5/5 |
| フェーズ2: CLAUDE.md再構成 | 完了 | 1/1 |
| フェーズ3: 確認 | 完了 | 1/1 |

**全体進捗**: 7/7 ステップ完了

### 2.2 アーキテクチャ変更

#### 新規ファイル
| ファイル | 責務 |
|---------|------|
| `.claude/rules/code-style.md` | コーディング規約 |
| `.claude/rules/testing.md` | テスト規約 |
| `.claude/rules/git.md` | Git規約 |
| `.claude/rules/backend.md` | バックエンド専用ルール（paths指定付き） |
| `.claude/rules/workflow.md` | 計画・実装ワークフロー |

#### 変更ファイル
| ファイル | 変更内容 |
|---------|---------|
| `CLAUDE.md` | ルール系セクションを削除し、ベストプラクティスセクションを追加。概要・構造・コマンドのみに絞る |

### 2.3 実装フェーズ

#### フェーズ1: ルールファイル作成

| ステップ | タスク | ファイル | 依存 | 完了条件 |
|----------|--------|---------|------|---------|
| 1.1 | - [x] コーディング規約ルールを作成 | `.claude/rules/code-style.md` | なし | 仕様 1.2 の code-style.md 定義内容が全て記載されている |
| 1.2 | - [x] テスト規約ルールを作成 | `.claude/rules/testing.md` | なし | 仕様 1.2 の testing.md 定義内容が全て記載されている |
| 1.3 | - [x] Git規約ルールを作成 | `.claude/rules/git.md` | なし | 仕様 1.2 の git.md 定義内容が全て記載されている |
| 1.4 | - [x] バックエンド専用ルールを作成 | `.claude/rules/backend.md` | なし | YAML frontmatter に paths 指定あり、仕様 1.2 の backend.md 定義内容が全て記載されている |
| 1.5 | - [x] ワークフロールールを作成 | `.claude/rules/workflow.md` | なし | 計画・SDD ワークフロー情報が CLAUDE.md から移動されている |

#### フェーズ2: CLAUDE.md再構成

| ステップ | タスク | ファイル | 依存 | 完了条件 |
|----------|--------|---------|------|---------|
| 2.1 | - [x] CLAUDE.md を再構成する | `CLAUDE.md` | 1.1〜1.5 | 概要・構造・コマンド・ベストプラクティスのみ残っている。ルール系セクションが全て削除されている |

#### フェーズ3: 確認

| ステップ | タスク | ファイル | 依存 | 完了条件 |
|----------|--------|---------|------|---------|
| 3.1 | - [x] 全ファイルの内容を確認 | 全対象ファイル | 2.1 | 全ファイルが仕様通りの内容で作成されている |

### 2.4 シンプリシティゲート

- [x] 各ルールファイルは1トピックに集中し、30行以内に収まる見込み
- [x] CLAUDE.md は不要セクション削除により現在より短くなる
- [x] 不要な抽象化・間接参照なし（各ファイルが独立して読める）

### 2.5 リスク評価

| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|---------|--------|
| paths 指定の記法ミス | 低 | 低 | ドキュメントの記法例に準拠する |
| ルール内容の重複 | 低 | 低 | 仕様で各ファイルの責務を明確に分離済み |

### 2.6 成功基準

仕様の受入基準（1.3）を満たすこと:

- [ ] AC-001: 全ルールファイルが Claude Code 起動時に読み込まれる
- [ ] AC-002: backend.md のルールが backend/ 以外に適用されない
- [ ] AC-003: backend.md のルールが backend/ 内で適用される
- [ ] AC-004: `/memory` で全ルールファイルが一覧表示される

### 2.7 実装ログ

| 日時 | ステップ | ステータス | 備考 |
|------|---------|-----------|------|
| 2026-01-31 | フェーズ1 (1.1〜1.5) | 完了 | ルールファイル5件を並行作成 |
| 2026-01-31 | フェーズ2 (2.1) | 完了 | CLAUDE.md再構成 |
| 2026-01-31 | フェーズ3 (3.1) | 完了 | 全ファイル仕様照合OK |

