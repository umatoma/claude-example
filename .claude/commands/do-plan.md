---
description: 要件を明確化し、リスクを評価し、ステップバイステップの実装計画を作成します。コードに触れる前にユーザーの確認を待ちます。
---

# Plan コマンド

このコマンドは **planner** エージェントを呼び出し、コードを書く前に包括的な実装計画を作成します。

## このコマンドの機能

1. **要件の明確化** - 何を構築するか明確にする
2. **リスクの特定** - 潜在的な問題やブロッカーを洗い出す
3. **ステップ計画の作成** - 実装をフェーズに分解する
4. **確認を待つ** - 進む前にユーザーの承認を必ず得る

## 使用タイミング

以下の場合に `/do-plan` を使用してください：
- 新機能の開発を始めるとき
- 重要なアーキテクチャ変更を行うとき
- 複雑なリファクタリングに取り組むとき
- 複数のファイル/コンポーネントに影響があるとき
- 要件が不明確または曖昧なとき

## 動作の仕組み

plannerエージェントは以下を行います：

1. **リクエストを分析**し、要件を明確な言葉で再記述
2. 具体的で実行可能なステップを持つ**フェーズに分解**
3. コンポーネント間の**依存関係を特定**
4. **リスクを評価**し、潜在的なブロッカーを特定
5. **複雑さを見積もり**（高/中/低）
6. `.steering/[YYYYMMDD]-[開発タイトル].md`に、**計画書を作成**する
7. **計画を提示**し、明示的な確認を待つ

## 使用例

```
ユーザー: /do-plan マーケットが解決したときにリアルタイム通知を追加したい

エージェント (planner):
# 実装計画: リアルタイムマーケット解決通知

## 要件の再記述
- ウォッチ中のマーケットが解決したときにユーザーに通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、webhook）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1: データベーススキーマ
- notificationsテーブルを追加（カラム: id, user_id, market_id, type, status, created_at）
- user_notification_preferencesテーブルを追加（チャネル設定用）
- パフォーマンスのためuser_idとmarket_idにインデックスを作成

### フェーズ2: 通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用した通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3: 統合ポイント
- マーケット解決ロジックにフック（ステータスが「resolved」に変わったとき）
- マーケットにポジションを持つ全ユーザーをクエリ
- 各ユーザーの通知をキューに追加

### フェーズ4: フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプションによるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク
- 高: メール到達性（SPF/DKIMが必要）
- 中: 1000人以上のユーザーがいるマーケットでのパフォーマンス
- 中: マーケットが頻繁に解決する場合の通知スパム
- 低: リアルタイムサブスクリプションのオーバーヘッド

## 推定複雑度: 中
- バックエンド: 4-6時間
- フロントエンド: 3-4時間
- テスト: 2-3時間
- 合計: 9-13時間

**確認待ち**: この計画で進めますか？（はい/いいえ/変更）
```

## 重要な注意事項

**重要**: plannerエージェントは、「はい」「進めてください」などの明示的な確認を受けるまで、**実装は進めません**。ただし、計画書の作成は行います。

変更が必要な場合は、以下のように返答してください：
- 「変更: [変更内容]」
- 「別のアプローチ: [代替案]」
- 「フェーズ2を飛ばしてフェーズ3を先にやって」

## 他のコマンドとの連携

計画後：
- 計画書に基づいて実装するには `/do-implement` を使用
- 実装完了後のレビューには `/code-review` を使用

## 関連エージェント

このコマンドは以下の場所にある `planner` エージェントを呼び出します：
`.claude/agents/planner.md`
